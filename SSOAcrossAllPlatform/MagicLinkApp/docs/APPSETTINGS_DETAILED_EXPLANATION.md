# AppSettings.json Detailed Field Explanation

## 📋 Complete Configuration Breakdown

### 🔍 Logging Section
```json
"Logging": {
  "LogLevel": {
    "Default": "Information",
    "Microsoft.AspNetCore": "Warning"
  }
}
```

**Field Details:**
- **Default: "Information"** → Shows Info, Warning, Error, Critical logs
- **Microsoft.AspNetCore: "Warning"** → Reduces ASP.NET Core noise, only shows warnings+
- **Purpose**: Controls console/debug output verbosity
- **Source**: Standard ASP.NET Core logging configuration

---

### 🌐 AllowedHosts Section
```json
"AllowedHosts": "*"
```

**Field Details:**
- **Value: "*"** → Allows requests from any host/domain
- **Purpose**: Host header validation for security
- **Production**: Should be specific domains like "localhost,magiclink.com"
- **Source**: ASP.NET Core host filtering middleware

---

### 🔐 Keycloak Section
```json
"Keycloak": {
  "Authority": "http://localhost:8081/realms/sso-realm",
  "ClientId": "magic-user",
  "ClientSecret": "kl3XReMn0qbl1OuE7NMsNbUVDaH8pmfS",
  "RequireHttpsMetadata": false,
  "ResponseType": "code",
  "Scope": "openid profile email",
  "SaveTokens": true,
  "GetClaimsFromUserInfoEndpoint": true
}
```

#### Authority Field
```json
"Authority": "http://localhost:8081/realms/sso-realm"
```
- **Source**: Keycloak realm URL
- **Format**: `{keycloak-base-url}/realms/{realm-name}`
- **Components**:
  - `localhost:8081` → Keycloak server address
  - `realms` → Fixed Keycloak path
  - `sso-realm` → Your custom realm name
- **Usage**: OpenID Connect discovery endpoint base
- **Discovery URL**: `{Authority}/.well-known/openid_configuration`

#### ClientId Field
```json
"ClientId": "magic-user"
```
- **Source**: Keycloak Admin Console → Clients → Create client
- **Where Set**: Client creation wizard, "Client ID" field
- **Purpose**: Identifies your application to Keycloak
- **Requirements**: Must be unique within the realm
- **Usage**: Sent in all OAuth/OIDC requests

#### ClientSecret Field
```json
"ClientSecret": "kl3XReMn0qbl1OuE7NMsNbUVDaH8pmfS"
```
- **Source**: Keycloak Admin Console → Clients → magic-user → Credentials tab
- **Where Found**: After enabling "Client authentication"
- **Generation**: Auto-generated by Keycloak or manually set
- **Purpose**: Authenticates your app to Keycloak (confidential client)
- **Security**: Never expose in client-side code

#### RequireHttpsMetadata Field
```json
"RequireHttpsMetadata": false
```
- **Purpose**: Validates HTTPS for Keycloak metadata endpoints
- **Development**: `false` (allows HTTP for localhost)
- **Production**: `true` (enforces HTTPS security)
- **Impact**: Affects .well-known/openid_configuration validation

#### ResponseType Field
```json
"ResponseType": "code"
```
- **Value**: Authorization Code Flow
- **Alternatives**: 
  - `"code"` → Authorization Code (recommended)
  - `"token"` → Implicit Flow (deprecated)
  - `"id_token"` → Implicit ID Token
- **Security**: Most secure OAuth flow
- **Process**: Code → Token exchange

#### Scope Field
```json
"Scope": "openid profile email"
```
- **openid**: Required for OIDC, provides ID token
- **profile**: User's profile info (name, username, etc.)
- **email**: User's email address and verification status
- **Source**: Keycloak Client Scopes configuration
- **Usage**: Determines what user data is accessible

#### SaveTokens Field
```json
"SaveTokens": true
```
- **Purpose**: Stores tokens in authentication cookie
- **Benefits**: Enables token refresh, API calls
- **Storage**: Encrypted in authentication cookie
- **Access**: Available via HttpContext.GetTokenAsync()

#### GetClaimsFromUserInfoEndpoint Field
```json
"GetClaimsFromUserInfoEndpoint": true
```
- **Purpose**: Fetches additional user claims from UserInfo endpoint
- **Endpoint**: `{Authority}/protocol/openid-connect/userinfo`
- **Benefits**: Gets latest user data, not just token claims
- **Performance**: Additional HTTP call during authentication

---

### 📧 Email Section
```json
"Email": {
  "SmtpHost": "smtp.gmail.com",
  "SmtpPort": 587,
  "Username": "sandeepkumar1464@gmail.com",
  "Password": "auwo ejto ieeb osda",
  "FromEmail": "sandeepkumar1464@gmail.com",
  "FromName": "Magic Link App"
}
```

#### SMTP Configuration
```json
"SmtpHost": "smtp.gmail.com",
"SmtpPort": 587
```
- **SmtpHost**: Gmail SMTP server address
- **SmtpPort**: 587 (STARTTLS), 465 (SSL), 25 (unsecured)
- **Protocol**: SMTP with STARTTLS encryption
- **Alternatives**: Outlook (smtp-mail.outlook.com), Yahoo, custom SMTP

#### Authentication
```json
"Username": "sandeepkumar1464@gmail.com",
"Password": "auwo ejto ieeb osda"
```
- **Username**: Gmail account email
- **Password**: Gmail App Password (not regular password)
- **Security**: App Password required for 2FA accounts
- **Generation**: Google Account → Security → App passwords

#### Email Headers
```json
"FromEmail": "sandeepkumar1464@gmail.com",
"FromName": "Magic Link App"
```
- **FromEmail**: Sender email address (must match Username for Gmail)
- **FromName**: Display name in email client
- **Usage**: Sets email "From" header

---

### 🔗 MagicLink Section
```json
"MagicLink": {
  "ExpiryMinutes": 15,
  "BaseUrl": "http://localhost:5200",
  "SecretKey": "kl3XReMn0qbl1OuE7NMsNbUVDaH8pmfS",
  "TestMode": "true"
}
```

#### ExpiryMinutes Field
```json
"ExpiryMinutes": 15
```
- **Purpose**: Magic link token validity duration
- **Security**: Shorter = more secure, longer = better UX
- **Recommended**: 5-30 minutes
- **Usage**: JWT token expiration claim

#### BaseUrl Field
```json
"BaseUrl": "http://localhost:5200"
```
- **Purpose**: Application base URL for magic link generation
- **Format**: `{BaseUrl}/magic-link/verify?token={token}`
- **Environment**: 
  - Development: `http://localhost:5200`
  - Production: `https://yourdomain.com`
- **Usage**: Email link construction

#### SecretKey Field
```json
"SecretKey": "kl3XReMn0qbl1OuE7NMsNbUVDaH8pmfS"
```
- **Purpose**: JWT token signing/validation key
- **Security**: Must be kept secret, minimum 32 characters
- **Usage**: Signs magic link tokens (separate from Keycloak ClientSecret)
- **Generation**: Random string, can reuse ClientSecret for simplicity

#### TestMode Field
```json
"TestMode": "true"
```
- **Purpose**: Enables testing without full Keycloak integration
- **Values**:
  - `"true"` → Bypasses some Keycloak validations
  - `"false"` → Full production mode
- **Development**: Useful for testing email flow
- **Production**: Must be `"false"`

---

## 🔄 Configuration Flow Mapping

### 1. Magic Link Generation
```
User Email → MagicLink.SecretKey → JWT Token → MagicLink.BaseUrl → Email
```

### 2. Email Sending
```
Email.Username/Password → Email.SmtpHost:SmtpPort → Email.FromEmail/FromName → User Inbox
```

### 3. Authentication Flow
```
Magic Link Click → Token Validation (MagicLink.SecretKey) → 
Keycloak Redirect (Keycloak.Authority + Keycloak.ClientId) → 
User Login → Token Exchange (Keycloak.ClientSecret) → 
User Claims (Keycloak.Scope) → Application Login
```

## 🔧 Configuration Sources

### From Keycloak Admin Console
1. **Authority**: Realm Settings → General → Endpoints
2. **ClientId**: Clients → Create client → Client ID
3. **ClientSecret**: Clients → magic-user → Credentials → Client secret

### From Email Provider
1. **SmtpHost/SmtpPort**: Provider documentation
2. **Username**: Your email account
3. **Password**: App password (Gmail) or account password

### Application Specific
1. **BaseUrl**: Your application URL
2. **SecretKey**: Generated secret for JWT signing
3. **ExpiryMinutes**: Business requirement
4. **TestMode**: Development vs production

## ✅ Validation Checklist

### Keycloak Settings Match
- ✅ Authority realm matches Keycloak realm
- ✅ ClientId exists in Keycloak clients
- ✅ ClientSecret matches Keycloak credentials
- ✅ Scope values are available in client scopes

### Email Settings Work
- ✅ SMTP credentials are valid
- ✅ App password generated (if using Gmail)
- ✅ FromEmail matches Username
- ✅ SMTP host/port are correct

### Magic Link Settings Secure
- ✅ SecretKey is sufficiently random
- ✅ ExpiryMinutes is reasonable (5-30)
- ✅ BaseUrl matches application URL
- ✅ TestMode is appropriate for environment

## 🐛 Common Configuration Errors

### Keycloak Issues
```
❌ "Invalid client" → ClientId doesn't exist in Keycloak
❌ "Unauthorized client" → ClientSecret mismatch
❌ "Invalid redirect URI" → BaseUrl not in Valid redirect URIs
❌ "Invalid scope" → Scope not available to client
```

### Email Issues
```
❌ "Authentication failed" → Wrong username/password
❌ "Connection refused" → Wrong SMTP host/port
❌ "Must use app password" → Need Gmail app password
❌ "From address rejected" → FromEmail doesn't match Username
```

### Magic Link Issues
```
❌ "Invalid token" → SecretKey mismatch or token expired
❌ "Link not working" → BaseUrl incorrect
❌ "Token expired" → ExpiryMinutes too short
❌ "Test mode errors" → TestMode setting incorrect
```